version: '3.8'

services:
  autoposter-bot:
    build: 
      context: .
      args:
        - REBUILD_CACHE=v2.1-$(date +%s)  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
    container_name: autoposter-bot-v2.1  # –ò–∑–º–µ–Ω–∏–ª –≤–µ—Ä—Å–∏—é
    restart: unless-stopped
    
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ Portainer)
    environment:
      # –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
      - BOT_TOKEN=${BOT_TOKEN}
      - ADMIN_IDS=${ADMIN_IDS}
      - CHANNEL_ID=${CHANNEL_ID}
      
      # AI —Å–µ—Ä–≤–∏—Å—ã
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_POST_MODEL=${OPENROUTER_POST_MODEL:-anthropic/claude-3-opus-20240229}
      - OPENROUTER_MAX_RETRIES=${OPENROUTER_MAX_RETRIES:-5}
      
      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      - FAL_AI_KEY=${FAL_AI_KEY}
      
      # VK –ø—É–±–ª–∏–∫–∞—Ü–∏—è
      - VK_ACCESS_TOKEN=${VK_ACCESS_TOKEN}
      - VK_GROUP_ID=${VK_GROUP_ID}
      - VK_CTA_TEXT=${VK_CTA_TEXT:-üîî –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à—É –≥—Ä—É–ø–ø—É!}
      
      # –ü—Ä–æ–∫—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - PROXY_URL=${PROXY_URL}
      
      # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    
    # –ú–æ–Ω—Ç–∏—Ä—É–µ–º —Ç–æ–º–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    volumes:
      - bot_data:/app/data
      - bot_database:/app/database  # –î–æ–±–∞–≤–∏–ª –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π —Ç–æ–º –¥–ª—è –ë–î
      - bot_backups:/app/backups
      - bot_temp:/app/temp
      - bot_logs:/app/logs
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

# –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–º–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
volumes:
  bot_data:
    driver: local
  bot_database:  # –î–æ–±–∞–≤–∏–ª –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π —Ç–æ–º
    driver: local
  bot_backups:
    driver: local
  bot_temp:
    driver: local
  bot_logs:
    driver: local 