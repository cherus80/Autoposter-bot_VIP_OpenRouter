version: '3.8'

services:
  autoposter-bot:
    build: .
    container_name: autoposter-bot-v2
    restart: unless-stopped
    
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
    environment:
      # –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
      - BOT_TOKEN=${BOT_TOKEN}
      - ADMIN_IDS=${ADMIN_IDS}
      - CHANNEL_ID=${CHANNEL_ID}
      
      # AI —Å–µ—Ä–≤–∏—Å—ã
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_POST_MODEL=${OPENROUTER_POST_MODEL:-deepseek/deepseek-r1:free}
      - OPENROUTER_IMAGE_PROMPT_MODEL=${OPENROUTER_IMAGE_PROMPT_MODEL:-deepseek/deepseek-r1:free}
      - OPENROUTER_MAX_RETRIES=${OPENROUTER_MAX_RETRIES:-5}
      
      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      - FAL_AI_KEY=${FAL_AI_KEY}
      
      # VK –ø—É–±–ª–∏–∫–∞—Ü–∏—è
      - VK_ACCESS_TOKEN=${VK_ACCESS_TOKEN}
      - VK_GROUP_ID=${VK_GROUP_ID}
      - VK_CTA_TEXT=${VK_CTA_TEXT:-üîî –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à—É –≥—Ä—É–ø–ø—É!}
      
      # –ü—Ä–æ–∫—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - PROXY_URL=${PROXY_URL}
      
      # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    
    # –ú–æ–Ω—Ç–∏—Ä—É–µ–º —Ç–æ–º–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    volumes:
      - ./database:/app/database  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
      - ./backups:/app/backups    # –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
      - ./temp:/app/temp          # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
      
    # –õ–æ–≥–∏
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 300s
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

# –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–º–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
volumes:
  bot_data:
    driver: local
  bot_database:
    driver: local
  bot_backups:
    driver: local
  bot_temp:
    driver: local
  bot_logs:
    driver: local

networks:
  default:
    driver: bridge 